TQ.Map={wrapper:null,bMap:null,bDriving:null,hlMarker:null,bMarker:null,eMarker:null,locationMarkerArr:[],bStationMarkerArr:[],eStationMarkerArr:[],lineMarkerArr:[],init:function(a,b){this.wrapper=$("#mapContainer"),this.setInfoWindow=this.setInfoWindow();var c=new BMap.Map("mapContainer");c.addControl(new BMap.NavigationControl),c.addControl(new BMap.ScaleControl),c.addControl(new BMap.OverviewMapControl),c.addControl(new BMap.MapTypeControl({mapTypes:[BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]})),c.addControl(new TQMapAllow),c.addControl(new TQToolControl),c.enableScrollWheelZoom(),c.setMinZoom(3);for(var d=new BMap.ContextMenu,e=[{text:"\u4ee5\u6b64\u4e3a\u8d77\u70b9",callback:function(a){(new BMap.Geocoder).getLocation(a,function(b){var c=TQ.Map,d=b.addressComponents,e=d.province+d.city+d.district+d.street+d.streetNumber;if(c.eMarker){var f=c.eMarker.getPosition(),g=$(c.eMarker.getContainer()).data("name");g!==e?TQ.Map.loadLine({bVal:e,eVal:g,typ:2,typ1:2,lng:a.lng,lat:a.lat,lng1:f.lng,lat1:f.lat}):alert("\u8d77\u59cb\u7ad9\u70b9\u4e0d\u80fd\u76f8\u540c")}else{c.bMap.removeOverlay(c.bMarker);var h=c.setMaker({url:"img/lineMapIconB.png",size:[37,32],offset:[4,-14],point:[a.lng,a.lat]});h.setTop(!0),$(h.getContainer()).data("name",e),c.bMap.addOverlay(h),c.bMarker=h}})}},{text:"\u4ee5\u6b64\u4e3a\u7ec8\u70b9",callback:function(a){(new BMap.Geocoder).getLocation(a,function(b){var c=TQ.Map,d=b.addressComponents,e=d.province+d.city+d.district+d.street+d.streetNumber;if(c.bMarker){var f=c.bMarker.getPosition(),g=$(c.bMarker.getContainer()).data("name");g!==e?TQ.Map.loadLine({bVal:g,eVal:e,typ:2,typ1:2,lng:f.lng,lat:f.lat,lng1:a.lng,lat1:a.lat}):alert("\u8d77\u59cb\u7ad9\u70b9\u4e0d\u80fd\u76f8\u540c")}else{c.bMap.removeOverlay(c.eMarker);var h=c.setMaker({url:"img/lineMapIconE.png",size:[37,32],offset:[4,-14],point:[a.lng,a.lat]});h.setTop(!0),$(h.getContainer()).data("name",e),c.bMap.addOverlay(h),c.eMarker=h}})}},{text:"\u5728\u9644\u8fd1\u627e",callback:function(a){(new BMap.Geocoder).getLocation(a,function(b){var c=b.addressComponents,d=new BMap.Marker(a);d.setTop(!0),TQ.Map.bMap.addOverlay(d);var e=TQ.Map.setInfoWindow(!0),f=c.province+c.city+c.district+c.street+c.streetNumber;e.find(".dn_sIWHeader").html('<span class="dn_sIWTitleAddr">'+f+"</span>");var g={lng:a.lng,lat:a.lat,addr:f,type:"Point"};e.data("info",g);var h=new BMap.InfoWindow(e.get(0));h.addEventListener("close",function(){TQ.Map.bMap.removeOverlay(d)}),d.openInfoWindow(h)})}},{text:"\u653e\u5927",callback:function(){c.zoomIn()}},{text:"\u5c45\u4e2d",callback:function(a){c.panTo(a)}},{text:"\u7f29\u5c0f",callback:function(){c.zoomOut()}}],f=0;f<e.length;f++)(2==f||3==f)&&d.addSeparator(),d.addItem(new BMap.MenuItem(e[f].text,e[f].callback,100));c.addContextMenu(d),a||alert("\u6ca1\u6709\u8bbe\u7f6e\u521d\u59cb\u5316\u5730\u70b9\u3002"),b=b||5,c.centerAndZoom(a,b),this.bMap=c,c.addEventListener("load",function(){"map"==k?TQ.Map.loadLocation({val:q,map:!0}):"0"==k&&q.length>0?TQ.Map.loadLocation({val:q,typ:q1,lng:x,lat:y}):"1"==k&&q.length>0&&q1.length>0?TQ.Map.loadStation({bVal:q,typ:tp,lng:x,lat:y,eVal:q1,typ1:tp1,lng1:x1,lat1:y1}):"2"==k&&q.length>0&&q1.length>0&&TQ.Map.loadDrive({bVal:q,eVal:q1})})},moveTo:function(a,b,c){c=c||16,this.bMap.setZoom(c),this.bMap.panTo(new BMap.Point(a,b))},zoomAuto:function(a){for(var b=[],c=a.length-1;c>=0;c--)b.push(a[c].point);var d=this.bMap.getViewport(b);this.bMap.centerAndZoom(d.center,d.zoom)},drawLine:function(a){for(var b=[],c=a.length-1;c>=0;c--)b.push(a[c].point);var d=new BMap.Polyline(b,{strokeColor:"blue",strokeWeight:6,strokeOpacity:.5});this.bMap.addOverlay(d)},setOverlays:function(a){for(var b=this.bMap,c=0,d=a.length;d>c;c++)b.addOverlay(a[c])},setMaker:function(a){a.url||"";var c=a.size||[10,10],d=a.offset||[0,0],e=a.point||[0,0],f=a.delay||!1,g=a.serial||["",!1],h=new BMap.Icon(a.url,new BMap.Size(c[0],c[1])),i=new BMap.Marker(new BMap.Point(e[0],e[1]),{icon:h,offset:new BMap.Size(d[0],d[1])}),j=null;return i.addEventListener("mouseover",function(){this.setTop(!0)}),i.addEventListener("mouseout",function(){this.setTop(!1)}),g&&(j=new BMap.Label(g[0],{offset:g[1]?new BMap.Size(7,4):new BMap.Size(6,3)}),j.setStyle({color:"#fff",border:"none",textAlign:"center",background:"none",fontWeight:"bold",fontSize:g[1]?"14px":"12px"}),i.setLabel(j)),f||this.bMap.addOverlay(i),i},setCircleMarker:function(a,b,c,d,e){var g=TQ.Map.setMaker({url:"http://css.8684.cn/map/img/selectedMarkerMapIcon.png",size:[34,37],offset:[3,-14],point:[b,c]}),h=new BMap.Circle(g.point,a,{strokeWeight:2,strokeOpacity:.7,strokeColor:"#3a6bdb",fillOpacity:.2,fillColor:"#3a6bdb"});if(this.bMap.addOverlay(g),this.bMap.addOverlay(h),e){var i=null;"Location"===e.type?this.bindLocationInfoWin(g,e):"Point"===e.type&&(i=this.setInfoWindow(!0),i.find(".dn_sIWHeader").html('<span class="dn_sIWTitleAddr">'+e.addr+"</span>"),i.data("info",e),oInfoWin=new BMap.InfoWindow(i.get(0)),oInfoWin.disableAutoPan(),g.addEventListener("click",function(){g.openInfoWindow(oInfoWin)}))}return g.addEventListener("click",function(){h.isVisible()?h.hide():h.show()}),d&&(this.bMap.setZoom(16),this.bMap.panTo(g.getPosition(),{noAnimation:!1})),g},setInfoWindow:function(){var a=$('<div class="dn_sIWWrap"><p class="dn_sIWHeader"></p></div>'),b=$('<ul class="dn_sIWTabs clear"><li class="dn_sIWTab dn_sIWTab-active"><span class="dn_sIWTabIconSearch"></span>\u5728\u9644\u8fd1\u627e</li><li class="dn_sIWTab"><span class="dn_sIWTabIconStar"></span>\u5230\u8fd9\u91cc\u53bb</li><li class="dn_sIWTab"><span class="dn_sIWTabIconEnd"></span>\u4ece\u8fd9\u91cc\u51fa\u53d1</li></ul>'),c=$('<div class="dn_sIWBoxs"><div class="dn_sIWBox dn_sIWBox-active"><span class="dn_sIWHotwords"><a href="#">\u9910\u996e</a><a href="#">\u9152\u5e97</a><a href="#">\u516c\u4ea4\u8f66\u7ad9</a><a href="#">\u94f6\u884c</a><a href="#">\u52a0\u6cb9\u7ad9</a></span><input type="text" class="dn_sIWKeyword" /><a href="#" class="dn_sIWKeywordBtn">\u641c\u7d22</a></div><div class="dn_sIWBox"><span class="dn_sIWLabel">\u8d77\u70b9\uff1a</span><input type="text" class="dn_sIWStart" /><a href="#" class="dn_sIWStartBtn">\u516c\u4ea4\u67e5\u8be2</a></div><div class="dn_sIWBox"><span class="dn_sIWLabel">\u7ec8\u70b9\uff1a</span><input type="text" class="dn_sIWEnd" /><a href="#" class="dn_sIWEndBtn">\u516c\u4ea4\u67e5\u8be2</a></div></div>');return b.children(".dn_sIWTab").on("click",function(){var a=$(this);a.hasClass("dn_sIWTab-active")||(a.addClass("dn_sIWTab-active").siblings().removeClass("dn_sIWTab-active"),a.parent().siblings(".dn_sIWBoxs").children().eq(a.index()).addClass("dn_sIWBox-active").siblings().removeClass("dn_sIWBox-active"))}),c.find(".dn_sIWHotwords > a").on("click",function(a){var b=$(this);b.parent().siblings(".dn_sIWKeyword").val(b.text()).siblings(".dn_sIWKeywordBtn").click(),a.preventDefault()}),c.find(".dn_sIWKeywordBtn").on("click",function(a){var b=$(this).parents(".dn_sIWWrap"),c=b.data("info"),d=$.trim(b.find(".dn_sIWKeyword").val());d.length>1?TQ.Map.loadLocation({val:d,lng:c.lng,lat:c.lat,info:c}):alert("\u8bf7\u8f93\u5165\u5173\u952e\u5b57"),a.preventDefault()}),c.find(".dn_sIWStartBtn").on("click",function(a){var b=$(this).parents(".dn_sIWWrap"),c=b.data("info"),d=b.find(".dn_sIWStart").val();$.trim(d).length>1?TQ.Map.loadStation({bVal:d,eVal:c.title||c.addr,lng1:c.lng,lat1:c.lat,typ1:2}):alert("\u8bf7\u8f93\u5165\u8d77\u70b9"),a.preventDefault()}),c.find(".dn_sIWEndBtn").on("click",function(a){var b=$(this).parents(".dn_sIWWrap"),c=b.data("info"),d=b.find(".dn_sIWEnd").val();$.trim(d).length>1?TQ.Map.loadStation({bVal:c.title||c.addr,eVal:d,lng:c.lng,lat:c.lat,typ:2}):alert("\u8bf7\u8f93\u5165\u7ec8\u70b9"),a.preventDefault()}),c.find(".dn_sIWKeyword, .dn_sIWStart, .dn_sIWEnd").on("keydown",function(a){13===a.keyCode&&$(this).next().click()}),function(d){var e=a.clone();return d&&e.addClass("dn_sIWWrap-large").append(b.clone(!0,!0),c.clone(!0,!0)),e}},bindLocationInfoWin:function(a,b){a.addEventListener("click",function(){var c=a.point,d=TQ.Map.setInfoWindow(!0);b.sid||d.find(".dn_sIWHeader").after('<p class="dn_sIWP">\u9644\u8fd1\u9152\u5e97\u9884\u8ba2\u70ed\u7ebf\uff1a<span class="xhh_phone">400-890-1889</span></p>'),d.find(".dn_sIWHeader").append('<span class="dn_sIWTitleLocation">'+b.title+"</span>"+(b.link?'<a href="'+b.link+'" target="_blank" class="dn_sIWDetail">\u8be6\u60c5</a>':"")+(com&&b.id>0?'<a href="'+b.link+'" class="dn_sIWCorrect" onclick="jl_jc('+b.id+',\'jc\');" target="_blank">\u7ea0\u9519</a>':"")).after('<p class="dn_sIWP">\u5730\u5740\uff1a'+b.address+'</p><p class="dn_sIWP">\u7535\u8bdd\uff1a<span class="xhh_phone">'+(b.sid?"400-890-1889":b.phone)+"</span></p>");var e=new BMap.InfoWindow(d.get(0));if(b.sid&&"hotel"!==b.sid){var f=$('<div class="dn_sIWHotel clear"><div class="dn_sIWHotelImg"><img src="'+(b.pic?b.pic:"/img/img-local-8684-com-404.jpg")+'" /></div><div class="dn_sIWHotelTable"></div></div>'),g=0,h=function(){var a=f.find(".dn_sIWHotelTable").empty().addClass("dn_loading");$.getJSON("http://beijing.8684.com/api/get_hotel_room.php?appkey=C16B3B79E50AB5C&jsoncallback=?",{id:b.sid,day1:formatDate("Y-m-d"),day2:formatDate("Y-m-d",(new Date).getTime()-864e5)},function(c){if(a.removeClass("dn_loading"),1===c.status){var d="",e=c.rooms.rooms||[],f=e.length>3?3:e.length,i=null,j=null,k=null;if(e.length>0){for(var l=0;f>l;l++)i=e[l],j=i.plans[0]?i.plans[0].totalprice:"-",k=i.plans[0]?i.plans[0].jiangjin:"-",d=d+'<tr><td><span class="dn_name" title="'+i.title+'">'+i.title+'</span></td><td><span class="dn_price">'+j+'</span></td><td><span class="dn_reward">'+k+'</span></td><td><a class="dn_bookBtn" href="http://hotel.8684.com/order_'+b.sid+"_"+i.rid+'" target="_blank">\u9884\u8ba2</a></td></tr>';a.append('<table class="dn_table"><thead><tr><th>\u623f\u95f4\u578b</th><th>\u65e5\u5747\u4ef7</th><th>\u8fd4\u73b0</th><th>\u9884\u8ba2</th></tr></thead><tbody></tbody><tfoot></tfoot></table>').find("tbody").append(d).end().find("tfoot").append('<tr><td colspan="4"><a class="dn_more" href="http://hotel.8684.com/h_'+b.sid+'" target="_blank">\u66f4\u591a\u4ef7\u683c\u6bd4\u8f83&gt;&gt;</a></td></tr>')}else a.append('<p class="dn_reload">\u6682\u65e0\u9884\u8ba2\u4fe1\u606f</p>')}else 5>g?h():a.append($('<p class="dn_reload" />').append($('<a href="javascript:;">\u70b9\u51fb\u91cd\u65b0\u52a0\u8f7d\u623f\u4ef7</a>').on("click",function(a){h(),a.preventDefault()})))}),g+=1};h.count=1,d.find(".dn_sIWHeader").after(f),e.addEventListener("open",function(){h()})}b.tids.indexOf("448")>-1&&d.find(".dn_sIWHeader").after('<a class="dn_sIWScenLink" target="_blank" href="http://lvyou.8684.cn/tc_list.php?key='+encodeURIComponent(b.title.replace(/\([\u4e00-\u9fa5]+\)/,""))+'">\u7279\u4ef7\u95e8\u7968\u9884\u8ba2</a>'),b.type="Location",b.lng=c.lng,b.lat=c.lat,d.data("info",b),a.openInfoWindow(e)})},bindStationInfoWin:function(a,b,c,d){a.addEventListener("click",function(){var e=TQ.Map.setInfoWindow();e.find(".dn_sIWHeader").append('<span class="dn_sIWTitleStation">'+b.title+"</span>").append($('<span class="dn_sIWZoomIn">\u653e\u5927</span>').on("click",function(){TQ.Map.bMap.zoomIn()})).after($('<div class="dn_sIWBtn">\u8bbe\u4e3a'+("e"==d?"\u7ec8":"\u8d77")+"\u70b9</div>").on("click",function(b){"b"==d?TQ.MapInfo.content.find("#bStationList").find(".dn_list > li:eq("+c+")").find(".dn_btn").click():"e"==d&&TQ.MapInfo.content.find("#eStationList").find(".dn_list > li:eq("+c+")").find(".dn_btn").click(),a.closeInfoWindow(),b.preventDefault()})).after('<p class="dn_sIWBus">\u7ebf\u8def\uff1a'+b.line+"</p>");var f=new BMap.InfoWindow(e.get(0));a.openInfoWindow(f)})},bindLineInfoWin:function(a,b){a.addEventListener("click",function(){var c=TQ.Map.setInfoWindow();c.find(".dn_sIWHeader").append('<span class="dn_sIWTitleLine">'+(""!==b.url?'<a href="'+b.url+'" target="_blank" class="dn_sIWLink">'+b.stop+"</a>":b.stop)+"</span>").append($('<span class="dn_sIWZoomIn">\u653e\u5927</span>').on("click",function(){TQ.Map.bMap.zoomIn()})).after('<p class="dn_sIWBus">'+b.info+"</p>");var d=new BMap.InfoWindow(c.get(0));a.openInfoWindow(d)})},removeMarker:function(){this.bMap&&this.bMap.clearOverlays(),this.locationMarkerArr=[],this.bStationMarkerArr=[],this.eStationMarkerArr=[],this.lineMarkerArr=[],this.bMarker=null,this.eMarker=null,this.hlMarker=null,this.bDriving&&this.bDriving.clearResults()},showLocationResult:function(a,b){for(var c=a.list||{},d=a.page||"",e=a.sum||0,f=[],g={},h={},i="",j=$(),k=null,l=TQ.Data.sn,m=0;m<c.length;m++)h=c[m],g=this.setMaker({url:"http://css.8684.cn/map/img/locationMapIcon.png",size:[29,31],offset:[2,-12],point:[h[0],h[1]],serial:[l[m]],delay:!0}),this.bindLocationInfoWin(g,{title:h[2],address:h[3],phone:h[4],link:h[5],id:h[6],sid:h[7],pic:h[7]?h[8]&&"http://tp1.znimg.com/images/nophoto_1.gif"!==h[8]?h[8]:"http://css.8684.cn/map/img/hotel/h_"+(Math.floor(19*Math.random())+1)+".jpg":"",tids:h[9]?h[9]:""}),f.push(g),i='<li class="clear"><span class="dn_icon">'+l[m]+"</span>",h[5]?(i+='<a href="'+h[5]+'" class="dn_link" target="_blank">\u8be6\u60c5&nbsp;&gt;&gt;</a>',i+='<span class="dn_name" title="'+h[2]+'">'+h[2]+"</span>"):i+='<a class="dn_name" target="_blank" title="'+h[2]+'">'+h[2]+"</a>",i+='<span class="dn_address" title="'+h[3]+'">'+h[3]+"</span>",i+=h[7]?'<span class="dn_phone">\u7535\u8bdd\uff1a400-890-1889</span>':'<span class="dn_phone">\u9644\u8fd1\u9152\u5e97\u9884\u8ba2\u70ed\u7ebf\uff1a400-890-1889</span>',h[6]>0&&com&&(i+='<span class="dn_handle"><a href="'+h[5]+'" class="dn_correct" onclick="jl_jc('+h[6]+',\'jc\')" target="_blank">\u7ea0\u9519</a></span>'),i+="</li>",k=$(i),j=j.add(k);$("#locationList").empty().append(j).parent().find(".pages").html(d),TQ.MapInfo.header.find(".dn_locationHeader .dn_sum").html(e?(1e3==e?"\u5927\u4e8e":"\u7ea6")+e+"\u6761\u7ed3\u679c":""),this.locationMarkerArr=f,this.setOverlays(f),b||this.zoomAuto(f)},showStationResult:function(a,b){b=b||"b";for(var c=a.list||null,e=[],f=null,g=null,h=$(),i=null,j="",k=TQ.Data.sn,l=0;l<c.length;l++)g=c[l],f=this.setMaker({url:"img/stationMapIcon.png",size:[29,31],offset:[2,-12],point:[g[1],g[2]],serial:[k[l]],delay:!0}),this.bindStationInfoWin(f,{title:g[3],line:g[4]},l,b),e.push(f),j='<li class="clear"><span class="dn_icon">'+k[l]+"</span>"+'<span class="dn_btn">\u8bbe\u4e3a'+("e"==b?"\u7ec8":"\u8d77")+"\u70b9</span>"+'<span class="dn_name" title="'+g[3]+'">'+g[3]+"</span>"+'<span class="dn_address" title="'+g[4]+'">'+g[4]+"</span>"+"</li>",i=$(j),h=h.add(i);this.setOverlays(e),this.zoomAuto(e),this[b+"StationMarkerArr"]=e,$("#"+b+"StationList").removeClass("dn_selected").children(".dn_list").empty().append(h).end().children(".dn_result").find("span").html("").removeAttr("alt")},showLineResult:function(a){var b=a.list||null;a.all_zhans||null;var d=[],e=0,f=0,g="",h=$(),i=null,j=[],k="";for(e=0;e<b.length;e++){for(d=b[e],i=$('<li><div class="dn_title clear"></div><div class="dn_detail"></div></li>'),i.find(".dn_title").append('<span class="dn_num">'+(e+1)+'</span><p class="dn_line"></p>'),f=0;f<d.length;f++)j.push(d[f][3]),k=""!==d[f][6]?'<a href="'+d[f][6]+'" target="_blank" class="dn_name">'+d[f][3]+"</a>":'<span class="dn_name">'+d[f][3]+"</span>",0===f?g+='<p class="dn_begin"><span class="dn_typeIcon"></span>'+k+"</p>":f==d.length-1?(1==d[f-1][0]?g+='<p class="dn_bus"><span class="dn_typeIcon"></span>\u4e58 '+d[f-1][4]+" \u5230</p>":2==d[f-1][0]?g+='<p class="dn_metro"><span class="dn_typeIcon"></span>\u4e58 '+d[f-1][4]+" \u5230</p>":0===d[f-1][0]&&(g+='<p class="dn_walk"><span class="dn_typeIcon"></span>\u6b65\u884c '+(""!==d[f-1][5]?d[f-1][5]+"\u7c73":"")+" \u81f3</p>"),g+='<p class="dn_end"><span class="dn_typeIcon"></span>'+k+"</p>"):1==d[f-1][0]?g+='<p class="dn_bus"><span class="dn_typeIcon"></span>\u4e58 '+d[f-1][4]+" \u5230 "+k+"</p>":2==d[f-1][0]?g+='<p class="dn_metro"><span class="dn_typeIcon"></span>\u4e58 '+d[f-1][4]+" \u5230 "+k+"</p>":0===d[f-1][0]&&(g+='<p class="dn_walk"><span class="dn_typeIcon"></span>\u6b65\u884c '+(""!==d[f-1][5]?d[f-1][5]+"\u7c73":"")+" \u81f3 "+k+"</p>");i.find(".dn_line").append(j.join('<span class="dn_arrow"></span>')),i.find(".dn_detail").append(g),h=h.add(i),j=[],g=""}$("#lineList").empty().append(h),h.eq(0).find(".dn_title").click()},showDriveResult:function(){},clearData:function(){TQ.Data.location=null,TQ.Data.bStation=null,TQ.Data.eStation=null,TQ.Data.line=null},preLoad:function(){TQ.MapInfo.displayBlock("wait"),this.removeMarker(),this.clearData()},loadLocation:function(a){var b=a.val||"",c=a.typ||0,d=a.lng||0,e=a.lat||0,f=a.map||!1,g=a.page||1,h=a.info||null,i=cityinfo[4]+"/so.php?k="+(f?"map":"0")+"&q="+encodeURI(b)+"&q1="+encodeURI(c)+"&x="+d+"&y="+e+"&page="+g,j=d&&e?!0:!1;this.preLoad(),ldjs("so_0",i,function(){add_kind2();var f=TQ.Map,i=TQ.MapInfo,k=TQ.Search,l=TQ.Data.location;i.content.find(".dn_locationList").data("args",a),j&&f.setCircleMarker(1e3,d,e,!0,h),l&&l.list&&l.list.length>0?(f.showLocationResult(l,j),i.displayBlock("location")):f.search_bd(g,b,d,e,j),TQ.History.push({type:"Location",value:a}),q=b,q1=c,x=d,y=e,k.locationInput.val(b),k.locationInput1.val(c),k.tabs.eq(0).click()})},loadStation:function(a){var b=a.bVal||"",c=a.eVal||"",d=a.bId||0,e=a.eId||0,f=a.typ||0,g=a.typ1||0,h=a.lng||0,i=a.lat||0,j=a.lng1||0,k=a.lat1||0,l=cityinfo[4]+"/so.php?k=1&q="+encodeURI(b)+"&q1="+encodeURI(c)+"&q_id="+d+"&q1_id="+e+"&tp="+f+"&tp1="+g+"&x="+h+"&y="+i+"&x1="+j+"&y1="+k;this.preLoad(),ldjs("so_1",l,function(){var l=TQ.Map,m=TQ.MapInfo,n=TQ.Search,o=TQ.Data.bStation,p=TQ.Data.eStation,r=TQ.Data.line;o&&o.list&&o.list.length>0&&p&&p.list&&p.list.length>0?(l.showStationResult(o,"b"),l.showStationResult(p,"e"),m.displayBlock("station")):r&&r.list.length>0?(l.showLineResult(r),m.content.find(".dn_lineBlock > .dn_reset").hide(),m.displayBlock("line")):m.displayBlock("error",b,c),TQ.History.push({type:"Station",value:a}),q=b,q1=c,tp=f,tp1=g,x=h,y=i,x1=j,y1=k,q_id=d,q1_id=e,n.bStationInput.val(b),n.eStationInput.val(c),n.bDriveInput.val(b),n.eDriveInput.val(c),n.tabs.eq(1).click()})},loadLine:function(a){var b=a.bVal||"",c=a.eVal||"",d=a.bId||0,e=a.eId||0,f=a.typ||0,g=a.typ1||0,h=a.lng||0,i=a.lat||0,j=a.lng1||0,k=a.lat1||0,l=cityinfo[4]+"/so.php?k=5&q="+encodeURI(b)+"&q1="+encodeURI(c)+"&q_id="+d+"&q1_id="+e+"&tp="+f+"&tp1="+g+"&x="+h+"&y="+i+"&x1="+j+"&y1="+k;this.preLoad(),ldjs("so_5",l,function(){var l=TQ.Map,m=TQ.MapInfo,n=TQ.Search,o=TQ.Data.line||null;o&&o.list&&o.list.length>0?(l.showLineResult(o),m.content.find(".dn_lineBlock > .dn_reset").show(),m.displayBlock("line")):m.displayBlock("error",b,c),TQ.History.push({type:"Line",value:a}),q=b,q1=c,tp=f,tp1=g,x=h,y=i,x1=j,y1=k,q_id=d,q1_id=e,n.bStationInput.val(b),n.eStationInput.val(c),n.bDriveInput.val(b),n.eDriveInput.val(c),n.tabs.eq(1).click()})},loadDrive:function(a){var b=a.bVal||"",c=a.eVal||"",d=a.pIdx||0,e=[BMAP_DRIVING_POLICY_LEAST_TIME,BMAP_DRIVING_POLICY_LEAST_DISTANCE,BMAP_DRIVING_POLICY_AVOID_HIGHWAYS],f=TQ.Map;this.preLoad(),this.bDriving=new BMap.DrivingRoute(this.bMap,{policy:e[d],renderOptions:{map:f.bMap,panel:"driveResult",autoViewport:!0},onSearchComplete:function(){var e=TQ.Map,f=TQ.MapInfo,g=TQ.Search,h=e.bDriving.getStatus();"undefined"!=typeof h&&h!==BMAP_STATUS_SUCCESS?f.displayBlock("error",b,c):(f.displayBlock("drive"),f.content.find(".dn_drivePolicys > li").eq(d).addClass("now").siblings().removeClass("now"),g.bDriveInput.val(b),g.eDriveInput.val(c),g.bStationInput.val(b),g.eStationInput.val(c),g.tabs.eq(2).click()),TQ.History.push({type:"Drive",value:a})},onMarkersSet:function(a){var b=a[0].marker,c=a[1].marker;b.enableDragging(),c.enableDragging(),b.addEventListener("dragend",function(a){var b=TQ.Map;b.removeMarker(),b.bDriving.search(a.point,c.getPosition())}),c.addEventListener("dragend",function(a){var c=TQ.Map;c.removeMarker(),c.bDriving.search(b.getPosition(),a.point)})}}),this.bDriving.setResultsHtmlSetCallback(function(){$(window).resize()}),this.bDriving.search(b,c)},search_bd:function(a,b,c,d,e){var f=a>1?!0:!1,g=15,h=new BMap.LocalSearch(this.bMap,{pageCapacity:g,onSearchComplete:function(c){if(h.getStatus()!=BMAP_STATUS_SUCCESS)return TQ.MapInfo.displayBlock("error",b),!1;var d=[],i={},j=c.getNumPois(),k=c.getCurrentNumPois(),l=null;if(i.list=[],i.page="",!(j>1))return TQ.MapInfo.displayBlock("error",b),!1;for(var m=0;k>m;m++)l=c.getPoi(m),void 0==l.address&&(l.address=""),void 0==l.phoneNumber&&(l.phoneNumber=""),d.push(l.title+"|"+l.point.lng+"|"+l.point.lat+"|"+l.address+"|"+l.phoneNumber+"|"+l.postcode+"|"+l.type+"|"+l.tags),i.list[m]=[l.point.lng,l.point.lat,l.title,l.address,l.phoneNumber,"",0];i.page=TQ.Map.pages_bd(Math.ceil(j/g),a),f?(h.gotoPage(a-1),f=!1):(TQ.Data.location=i,TQ.Map.showLocationResult(i,e),TQ.MapInfo.displayBlock("location"))}});c>0&&d>0?h.searchNearby(cityinfo[2]+b,new BMap.Point(c,d),1e3):h.search(cityinfo[2]+b)},pages_bd:function(a,b){if(2>a)return"";var c="",d=1;for(b>=5&&a>7&&(d=b-2,c+='<a href="#" alt="1" target="_self">\u9996\u9875</a>'),b>1&&(c+='<a href="#" alt="'+(b-1)+'" target="_self">\u4e0a\u4e00\u9875</a>'),i=d;d+5>i;i++)i==b?c+='<a href="#" class="current" alt="" target="_self">'+i+"</a>":a>=i&&(c+='<a href="#" alt="'+i+'" target="_self">'+i+"</a>");return a>b&&(c+='<a href="#" alt="'+(b+1)+'" target="_self">\u4e0b\u4e00\u9875</a>'),c}},TQ.MapInfo={wrapper:null,footer:null,header:null,content:null,init:function(){this.wrapper=$("#mapInfo"),this.footer=$("#footer"),this.header=this.wrapper.find(".dn_header"),this.content=this.wrapper.find(".dn_content"),$(".mainLeft").append($('<div class="dn_closeSideBtn dn_openBtn" id="closeSideBtn" />').toggle(function(a){$(".mainLeft").css("margin-left","-340px"),$(".main").css("padding-left","0px"),$(this).removeClass("dn_openBtn"),$(this).addClass("dn_closedBtn"),a.preventDefault()},function(a){$(".mainLeft").css("margin-left","0px"),$(".main").css("padding-left","340px"),$(this).removeClass("dn_closedBtn"),$(this).addClass("dn_openBtn"),a.preventDefault()})),$(function(){$g("ad_resLc").innerHTML=$g("ad_res").innerHTML,$g("ad_resLn").innerHTML=$g("ad_res").innerHTML,$g("ad_resdr").innerHTML=$g("ad_res").innerHTML,$g("ad_res").innerHTML="",$g("ad_resLcBtm").innerHTML=$g("ad_resBtm").innerHTML,$g("ad_resLnBtm").innerHTML=$g("ad_resBtm").innerHTML,$g("ad_resdrBtm").innerHTML=$g("ad_resBtm").innerHTML,$g("ad_resBtm").innerHTML=""}),this.initHome(),this.initError(),this.initLocation(),this.initStation(),this.initLine(),this.initDrive()},initHome:function(){},initError:function(){this.header.on("click",".dn_errorHeader > .dn_back",function(a){a.preventDefault(),TQ.History.back()})},initLocation:function(){this.header.on("click",".dn_locationHeader > .dn_back",function(a){a.preventDefault(),TQ.History.back()});var a=this.content.find("#locationList");a.on("click","li",function(){var a=TQ.Map.locationMarkerArr[$(this).index()];TQ.Map.moveTo(a.point.lng,a.point.lat),$(a.getContainer()).click()}),a.on("mouseenter","li",function(){var a=TQ.Map,b=$(this),c=b.index(),d=a.locationMarkerArr[c].getPosition(),e=a.hlMarker||null;b.addClass("hover").siblings().removeClass("hover"),e&&(a.bMap.removeOverlay(e),e=null),e=a.setMaker({url:"http://css.8684.cn/map/img/selectedMarkerMapIcon.png",size:[34,37],offset:[3,-14],point:[d.lng,d.lat],serial:[TQ.Data.sn[c],!0]}),e.setZIndex(99),a.bMap.addOverlay(e),a.hlMarker=e}),a.on("mouseleave","li",function(){var a=TQ.Map;$(this).removeClass("hover"),a.bMap.removeOverlay(a.hlMarker),a.hlMarker=null}),a.parent().find(".pages").on("click","a",function(b){var c=$(this).attr("alt"),d=a.data("args");return c?(d.page=parseInt(c,10),TQ.Map.loadLocation(d),b.preventDefault(),void 0):!1})},initStation:function(){this.header.on("click",".dn_stationHeader > .dn_back",function(a){a.preventDefault(),TQ.History.back()});var a=this.content.find(".dn_stationBlock");a.on("click",".dn_selected > .dn_result",function(){$(this).children("span").html("").removeAttr("alt").parents(".dn_select").removeClass("dn_selected"),$(window).resize()}),a.on("mouseenter",".dn_list > li",function(){var a=TQ.Map,b=$(this),c=b.index(),d=a[b.parent().attr("alt")+"StationMarkerArr"][c],e=d.getPosition(),f=a.hlMarker||null;b.addClass("hover").siblings().removeClass("hover"),a.moveTo(e.lng,e.lat),$(d.getContainer()).click(),f&&(a.bMap.removeOverlay(f),f=null),f=a.setMaker({url:"http://css.8684.cn/map/img/selectedMarkerMapIcon.png",size:[34,37],offset:[3,-14],point:[e.lng,e.lat],serial:[TQ.Data.sn[c],!0]}),f.setZIndex(99),a.bMap.addOverlay(f),a.hlMarker=f}),a.on("click",".dn_list > li > .dn_btn",function(){var a=TQ.Data,b=$(this).parent(),c=b.parent(),d=b.index(),e=a[c.attr("alt")+"Station"].list;if(b.closest(".dn_select").addClass("dn_selected").find(".dn_result > span").html(e[d][3]).attr("alt",d),2===c.closest(".dn_stationBlock").children(".dn_selected").size()){var f=a.bStation.list[$("#bStationList").find(".dn_result > span").attr("alt")],g=a.eStation.list[$("#eStationList").find(".dn_result > span").attr("alt")];TQ.Map.loadLine({bVal:f[3],eVal:g[3],bId:f[6],eId:g[6],typ:f[5],typ1:g[5],lng:f[1],lat:f[2],lng1:g[1],lat1:g[2]})}else $(window).resize()}),a.on("mouseleave",".dn_list > li",function(){TQ.Map.bMap.removeOverlay(TQ.Map.hlMarker),TQ.Map.hlMarker=null,$(this).removeClass("hover")})},initLine:function(){this.header.on("click",".dn_lineHeader > .dn_back",function(a){a.preventDefault(),TQ.History.back()});var a=this.content.find(".dn_lineBlock");a.on("click",".dn_lineHandle > .dn_return",function(a){a.preventDefault();var b=TQ.History.now().value;TQ.Map.loadLine({bVal:b.eVal,eVal:b.bVal,bId:b.eId,eId:b.bId,typ:b.typ1,typ1:b.typ,lng:b.lng1,lat:b.lat1,lng1:b.lng,lat1:b.lat})}),a.on("click",".dn_lineList .dn_title",function(a){var b=TQ.Map,c=0,d=$(this).parent("li").index(),e=TQ.Data.line.list[d],f=TQ.Data.line.all_zhans[d],g=[],i=[],j={},k=$(this).parent(),l=TQ.MapInfo.header.find(".dn_lineHeader > .dn_title"),m=[["img/lineMapIconWalk.png",24,24],["img/lineMapIconBus.png",24,24],["img/lineMapIconMetro.png",24,24],["img/lineMapIconB.png",37,32,4,-14],["img/lineMapIconE.png",37,32,4,-14]];if(b.removeMarker(),k.toggleClass("selected").siblings().removeClass("selected"),k.hasClass("selected")){for(l.children().eq(0).html(e[0][3]).end().eq(1).html(e[e.length-1][3]),l.attr("title",e[0][3]+" \u5230 "+e[e.length-1][3]),c=0;c<f.length;c++)g=f[c],0!==g[1]&&0!==g[2]&&(0===c?(j=b.setMaker({url:m[3][0],size:[m[3][1],m[3][2]],offset:[m[3][3],m[3][4]],point:[g[1],g[2]]}),j.setAnimation(BMAP_ANIMATION_BOUNCE),$(j.getContainer()).data("name",e[0][3]),b.bMarker=j):c==f.length-1?(j=b.setMaker({url:m[4][0],size:[m[4][1],m[4][2]],offset:[m[4][3],m[4][4]],point:[g[1],g[2]]}),j.setAnimation(BMAP_ANIMATION_BOUNCE),$(j.getContainer()).data("name",e[e.length-1][3]),b.eMarker=j):j=b.setMaker({url:m[g[0]][0],size:[m[g[0]][1],m[g[0]][2]],point:[g[1],g[2]]}),b.bindLineInfoWin(j,{stop:g[3],url:g[5],info:g[4]}),i.push(j));b.drawLine(i),b.zoomAuto(i),b.lineMarkerArr=i}$(window).resize(),a.preventDefault()})},initDrive:function(){this.header.on("click",".dn_driveHeader > .dn_back",function(a){a.preventDefault(),TQ.History.back()}),this.content.find(".dn_drivePolicys > li").on("click",function(){$(this).addClass("now").siblings().removeClass("now"),$("#driveSearch").submit()})},displayBlock:function(a,b,c){this.content.find(".dn_"+a+"Block").show().siblings().hide(),"home"===a||"wait"===a?(this.header.hide(),this.footer.show()):(this.header.show().find(".dn_"+a+"Header").show().siblings().hide(),this.footer.hide()),$(window).resize(),"error"===a&&($("#gad_err1").empty().removeAttr("style"),$("#gad_err2").empty().removeAttr("style"),$(window).resize(),b&&"undefined"!=typeof google&&google&&new google.ads.search.Ads({pubId:"pub-8681123601734660",hl:"zh-CN",titleBold:!1,rolloverLinkBold:!0,rolloverLinkColor:"#FF0000",width:"auto",lines:3,channel:"2089701322",siteLinks:!1,fontFamily:"arial",fontSizeTitle:"14px",fontSizeDescription:"13px",fontSizeDomainLink:"13px",colorText:"#000000",colorDomainLink:"#666666",colorBackground:"#FFFFFF",colorBorder:"#FFFFFF",rolloverLinkColor:"#FF0000",linkTarget:"_blank",query:b,rolloverAdBackgroundColor:"#FFF1C2",oe:"gb"},{container:"gad_err1",colorBackground:"#fff",adsafe:"low",minTop:3}),c&&"undefined"!=typeof google&&google&&new google.ads.search.Ads({pubId:"pub-8681123601734660",hl:"zh-CN",titleBold:!1,rolloverLinkBold:!0,rolloverLinkColor:"#FF0000",width:"auto",lines:3,channel:"2089701322",siteLinks:!1,fontFamily:"arial",fontSizeTitle:"14px",fontSizeDescription:"13px",fontSizeDomainLink:"13px",colorText:"#000000",colorDomainLink:"#666666",colorBackground:"#FFFFFF",colorBorder:"#FFFFFF",rolloverLinkColor:"#FF0000",linkTarget:"_blank",query:c,rolloverAdBackgroundColor:"#FFF1C2",oe:"gb"},{container:"gad_err2",colorBackground:"#fff",adsafe:"low",minTop:3}),function(){var a=(new Date).getTime(),b=getEleById("gad_err1"),c=getEleById("gad_err2"),d=b.style.height,e=c.style.height,f=setInterval(function(){(d!=b.style.height||e!=c.style.height||(new Date).getTime()-1e4>a)&&(clearInterval(f),f=null,$(window).resize())},1e3)}())}},TQ.History={list:[{type:"home",value:{}}],getLength:function(){return this.list.length},now:function(){return this.list[this.list.length-1]},back:function(){return this.list.length>1?(this.go(this.list.length-1-1),void 0):!1},push:function(a){var b=a.value,c={};for(var d in b)c[d]=b[d];this.list.push({type:a.type,value:c})},go:function(a){var b=null;if(!(a<=this.list.length-1))return!1;if(b=this.list[a],a>0)for(;this.list.length>a;)this.list.pop();else this.list.pop();1>a&&"home"===b.type?(TQ.MapInfo.displayBlock("home"),TQ.Map.removeMarker(),TQ.Map.clearData()):TQ.Map["load"+b.type](b.value)}};