<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Bus">
	<typeAlias alias="dto" type="org.g4studio.core.metatype.impl.BaseDto" />
	<typeAlias alias="catalogVO" type="org.g4studio.demo.dao.vo.CatalogVO" />
	<typeAlias alias="userVo" type="org.g4studio.system.admin.web.tag.vo.UserVo"/>

	
	<!-- 定义出入参对象映射:测试游标 -->
	<parameterMap id="prcdto_cur" class="map">
		<parameter property="prm_Xm" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN" /> <!-- 入参 -->
		<parameter property="cur_list"  jdbcType="ORACLECURSOR" javaType="java.sql.ResultSet"  mode="OUT" resultMap="cur_dto"/>
		<parameter property="appCode" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT" /> <!-- 执行代码 -->
		<parameter property="errMsg" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT" /> <!-- 出错信息 -->
	</parameterMap>
	<resultMap id="cur_dto" class="dto">
		<result column="xm" property="xm" jdbcType="VARCHAR"/>
		<result column="fyze" property="fyze" jdbcType="DECIMAL"/>
	</resultMap>
	<procedure id="g4_prc_cursor_demo" parameterMap="prcdto_cur">{call g4_prc_cursor_demo(?,?,?,?)}</procedure>
	
	
	<select id="countStddev_bak" parameterClass="map" resultClass="dto">
		SELECT 
		
		time_format(SEC_TO_TIME(stddev(TIME_TO_SEC(t.StartToMiddle))),'%H.%i.%s') as downpuls,
		time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.StartToMiddle))),'%H.%i.%s')
		 as downav  ,


		time_format(SEC_TO_TIME(stddev(TIME_TO_SEC(t.MiddleToEnd))),'%H.%i.%s') as uppuls,
			time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.MiddleToEnd))),'%H.%i.%s') as upav,
			
			t.ROUTEID as routeName FROM bus.tb_triptime t where 1=1   
			<dynamic>
			<isNotEmpty prepend="AND" property="selectroute">
				t.ROUTEID = #selectroute#
			</isNotEmpty>
			
			 group by t.ROUTEID
		</dynamic>
		
		
		
		
	</select>
	
	
	<select id="countStddev" parameterClass="map" resultClass="dto">
		
		select  aa.ROUTEID as routename, aa.time1,bb.time2,cc.time3,(time1+time2+time3) as totaltime ,aa.Weather as weather,
		(aa.avtime1+bb.avtime2+cc.avtime3) as avtime, aa.UporDown as upordown,aa.TimeSection as timeinterval,aa.TimeInterval as timenum
		

			from 
			( SELECT 
			t.TimeSection,t.UporDown,t.TimeInterval,t.Weather,

			time_format(SEC_TO_TIME(stddev((TIME_TO_SEC(t.triptime)*#bit1#))),'%i.%s') as time1,
			time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.triptime)*#bit1#)),'%i.%s') as avtime1,

			

			t.ROUTEID  FROM bus.tb_triptime t where 1=1 
			
			<dynamic>
			
			<isNotEmpty prepend="AND" property="route">
				t.ROUTEID = #route#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updown_name">
				t.UporDown = #updown_name#
			</isNotEmpty>
			
			</dynamic>
 				and   
 				  <![CDATA[
             t.Startdate>str_to_date("2014-03-26 ",'%Y-%m-%d ')  and t.Startdate<str_to_date("2014-04-05 ",'%Y-%m-%d ')
 			
      ]]>
 					
 				group by t.ROUTEID  ,t.TimeInterval order by t.TimeInterval) aa,


			( SELECT 
			t.TimeSection,t.UporDown,t.TimeInterval,t.Weather,

 
			time_format(SEC_TO_TIME(stddev((TIME_TO_SEC(t.triptime)*#bit2#))),'%i.%s') as time2,
			time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.triptime)*#bit2#)),'%i.%s') as avtime2,

			

				t.ROUTEID  FROM bus.tb_triptime t where 1=1 
				<dynamic>
			
			<isNotEmpty prepend="AND" property="route">
				t.ROUTEID = #route#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updown_name">
				t.UporDown = #updown_name#
			</isNotEmpty>
			</dynamic>
 				 and   
 				 <![CDATA[
 				
 				t.Startdate>str_to_date("2014-04-05 ",'%Y-%m-%d ')  and t.Startdate<str_to_date("2014-04-15 ",'%Y-%m-%d ') 
 				]]>
 				
 				group by t.ROUTEID  ,t.TimeInterval order by t.TimeInterval ) bb,

			( SELECT 
				t.TimeSection,t.UporDown,t.TimeInterval,t.Weather,
				time_format(SEC_TO_TIME(stddev((TIME_TO_SEC(t.triptime)*#bit3#))),'%i.%s') as  time3,
				time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.triptime)*#bit3#)),'%i.%s') as avtime3,
				

				t.ROUTEID  FROM bus.tb_triptime t where 1=1 
				<dynamic>
			
			<isNotEmpty prepend="AND" property="route">
				t.ROUTEID = #route#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updown_name">
				t.UporDown = #updown_name#
			</isNotEmpty>
			</dynamic>
 				 and 
 				<![CDATA[
 				  t.Startdate>str_to_date("2014-04-15 ",'%Y-%m-%d ')  and t.Startdate<str_to_date("2014-04-25 ",'%Y-%m-%d ') 
 				
 				]]>
 				group by t.ROUTEID  ,t.TimeInterval order by t.TimeInterval ) cc

			where aa.TimeInterval = bb.TimeInterval and bb.TimeInterval = cc.TimeInterval

	</select>
	
	
		<select id="compareBustime" parameterClass="map" resultClass="dto">

	select a.ROUTEID as routename , a.rundate  ,a.StartTime,as_triptime as triptime ,a.productid,
b.TimeInterval ,b.totaltime,b.weather,b.avtime,b.upordown,b.timeinterval

  	 from  (SELECT n.productid,time_format(SEC_TO_TIME((TIME_TO_SEC(n.TripTime))),'%H.%i.%s')    as as_triptime ,
  	 n.Startdate as rundate,time_format(n.StartTime,'%H.%i.%s') as StartTime,n.ROUTEID as ROUTEID,n.timeinterval 

 FROM tb_triptime n where n.ROUTEID =#selectroute#  and  n.Startdate = #datetime#
 	<dynamic>
 			<isNotEmpty prepend="AND" property="updown_name">
				n.UporDown = #updown_name#
			</isNotEmpty>
	</dynamic>
 )   a 
left join (
			select  aa.ROUTEID as routename, aa.time1,bb.time2,cc.time3,(time1+time2+time3) as totaltime ,aa.Weather as weather,
		(aa.avtime1+bb.avtime2+cc.avtime3) as avtime, aa.UporDown as upordown,aa.TimeSection as timeinterval,aa.TimeInterval as timenum
		

			from 
			( SELECT 
			t.TimeSection,t.UporDown,t.TimeInterval,t.Weather,t.StartTime,

			time_format(SEC_TO_TIME(stddev((TIME_TO_SEC(t.triptime)*#bit1#))),'%i.%s') as time1,
			time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.triptime)*#bit1#)),'%i.%s') as avtime1,

			

			t.ROUTEID  FROM bus.tb_triptime t where 1=1 
			
			<dynamic>
			
			<isNotEmpty prepend="AND" property="route">
				t.ROUTEID = #selectroute#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updown_name">
				t.UporDown = #updown_name#
			</isNotEmpty>
			
			</dynamic>
 				and   
 				  <![CDATA[
             t.Startdate>str_to_date("2014-03-26 ",'%Y-%m-%d ')  and t.Startdate<str_to_date("2014-04-05 ",'%Y-%m-%d ')
 			
      ]]>
 					
 				group by t.ROUTEID  ,t.TimeInterval order by t.TimeInterval) aa,


			( SELECT 
			t.TimeSection,t.UporDown,t.TimeInterval,t.Weather,t.StartTime,

 
			time_format(SEC_TO_TIME(stddev((TIME_TO_SEC(t.triptime)*#bit2#))),'%i.%s') as time2,
			time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.triptime)*#bit2#)),'%i.%s') as avtime2,

			

				t.ROUTEID  FROM bus.tb_triptime t where 1=1 
				<dynamic>
			
			<isNotEmpty prepend="AND" property="route">
				t.ROUTEID = #selectroute#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updown_name">
				t.UporDown = #updown_name#
			</isNotEmpty>
			</dynamic>
 				 and   
 				 <![CDATA[
 				
 				t.Startdate>str_to_date("2014-04-05 ",'%Y-%m-%d ')  and t.Startdate<str_to_date("2014-04-15 ",'%Y-%m-%d ') 
 				]]>
 				
 				group by t.ROUTEID  ,t.TimeInterval order by t.TimeInterval ) bb,

			( SELECT 
				t.TimeSection,t.UporDown,t.TimeInterval,t.Weather,t.StartTime,
				time_format(SEC_TO_TIME(stddev((TIME_TO_SEC(t.triptime)*#bit3#))),'%i.%s') as  time3,
				time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.triptime)*#bit3#)),'%i.%s') as avtime3,
				

				t.ROUTEID  FROM bus.tb_triptime t where 1=1 
				<dynamic>
			
			<isNotEmpty prepend="AND" property="route">
				t.ROUTEID = #selectroute#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updown_name">
				t.UporDown = #updown_name#
			</isNotEmpty>
			</dynamic>
 				 and 
 				<![CDATA[
 				  t.Startdate>str_to_date("2014-04-15 ",'%Y-%m-%d ')  and t.Startdate<str_to_date("2014-04-25 ",'%Y-%m-%d ') 
 				
 				]]>
 				group by t.ROUTEID  ,t.TimeInterval order by t.TimeInterval ) cc

			where aa.TimeInterval = bb.TimeInterval and bb.TimeInterval = cc.TimeInterval
	

) b on a.ROUTEID = b.routename and a.timeinterval =b.timenum
	</select>
	
	<select id="countcompareBustime" parameterClass="map" resultClass="java.lang.Integer">
	
	select count(*)
  	 from  (SELECT * 

 FROM tb_triptime n where n.ROUTEID =#selectroute#  and  n.Startdate = #datetime#) a 

	</select>
	
	<select id="queryCompanyDatas" parameterClass="map" resultClass="dto">
		SELECT DEPTID as value, DEPTNAME as text
		FROM eadept t where 1=1  and t.enabled='1'  
		<dynamic >
			
			<isNotEmpty prepend="and" property="deptlength">
				length(DEPTID) = $deptlength$
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="queryrouteDatas" parameterClass="map" resultClass="dto">
		SELECT id as value, routename as text
		FROM meta_dept_route t 
		<dynamic prepend="where">
			
			<isNotEmpty prepend="and" property="deptid">
				DEPTID = $deptid$
			</isNotEmpty>
		</dynamic>
	</select>
	
	
	
	<select id="querysitespeed" parameterClass="map" resultClass="dto">
		SELECT *
		FROM tb_station_speed  t 
		<dynamic prepend="where">
			
			<isNotEmpty prepend="and" property="datetime">
				t.date = #datetime#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="selectroute">
				t.route = #selectroute#
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="countquerysitespeed" parameterClass="map" resultClass="java.lang.Integer">
		select count(*)
		FROM tb_station_speed  t 
		<dynamic prepend="where">
			
			<isNotEmpty prepend="and" property="datetime">
				t.date = #datetime#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="selectroute">
				t.route = #selectroute#
			</isNotEmpty>
		</dynamic>
	</select>
	
	
	
	
	<select id="querybustour" parameterClass="map" resultClass="dto">
		SELECT t.routeid,t.date,t.productid,t.stationnum,t.upordown,time_format(t.time,'%H.%i.%s') as time
		FROM tb_banci  t where (t.upordown = '1' or  t.upordown = '3')
		<dynamic >
			
			<isNotEmpty prepend="and" property="datetime">
				t.date =  str_to_date(#datetime#,'%Y-%m-%d ')
			</isNotEmpty>
			<isNotEmpty prepend="and" property="selectroute">
				t.routeid = #selectroute#
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="countquerybustour" parameterClass="map" resultClass="java.lang.Integer">
		select count(*)
		FROM tb_banci  t  where (t.upordown = '1' or  t.upordown = '3')
		<dynamic >
			
			<isNotEmpty prepend="and" property="datetime">
				t.date = str_to_date(#datetime#,'%Y-%m-%d ')
			</isNotEmpty>
			<isNotEmpty prepend="and" property="selectroute">
				t.routeid = #selectroute#
			</isNotEmpty>
		</dynamic>
	</select>
	
	
	
	
		<select id="querybustourReport" parameterClass="map" resultClass="dto">
		select count(b.hour) as num,b.routeid ,b.hour from (SELECT   time_format(t.time,'%H') as hour, t.routeid, t.stationnum 

	FROM bus.tb_banci  t 
	
	<dynamic prepend="where">
			
			<isNotEmpty prepend="and" property="datetime">
				t.date = #datetime#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="upordown">
				t.upordown = #upordown#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="selectroute">
				t.routeid = #selectroute#
			</isNotEmpty>
		</dynamic>
	
	) b group by b.hour 
		
		
		
	</select>
	
	
	<select id="queryoverspeed" parameterClass="map" resultClass="dto">
		SELECT t.routeid,t.date,time_format(t.time,'%H.%i.%s') as time,t.productid,t.nowvalue,t.station ,(t.nowvalue-t.standard)/t.standard*100 as overrate
		FROM tb_alert_03_04  t  where 1=1 and t.type= '31'
		<dynamic >
			
			<isNotEmpty prepend="and" property="datetime">
				t.date = #datetime#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="selectroute">
				t.routeid = #selectroute#
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="countqueryoverspeed" parameterClass="map" resultClass="java.lang.Integer">
		select count(*)
		FROM tb_alert_03_04  t where 1=1 and t.type= '31'
		<dynamic >
			
			<isNotEmpty prepend="and" property="datetime">
				t.date = #datetime#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="selectroute">
				t.routeid = #selectroute#
			</isNotEmpty>
		</dynamic>
	</select>
	
	
	<select id="countoverspeedbit" parameterClass="map" resultClass="java.lang.Integer">
		select count(*)
		FROM tb_alert_03_04  t where 1=1 and t.type= '31'
		<dynamic >
			<isNotEmpty prepend="and" property="selectroute">
				t.routeid = #selectroute#
			</isNotEmpty>
			
			<isNotEmpty prepend="and" property="bit1">
		<![CDATA[
 				 (t.nowvalue-t.standard)/t.standard>#bit1# 
 				
 				]]>
			</isNotEmpty>
			<isNotEmpty prepend="and" property="bit2">
		<![CDATA[
 				 (t.nowvalue-t.standard)/t.standard<#bit2# 
 				
 				]]>
			</isNotEmpty>
		</dynamic>
	</select>
	
	
	
	
	
	<select id="querybusUse" parameterClass="map" resultClass="dto">
	select route,count(e.PRODUCTID) as usenum,#datetime# as rundate from(
 		select distinct(a.PRODUCTID ), a.Route from meta_site_route a where a.route in (

		select b.routeid from meta_dept_route b 
		<dynamic prepend="where">
			<isNotEmpty prepend="and" property="companyName">
				 b.deptid= #companyName#
			</isNotEmpty>
			
			
		 </dynamic>
		)	
		
		<dynamic >
			<isNotEmpty prepend="and" property="datetime1">
			<![CDATA[
 				 a.StartTime> STR_TO_DATE(#datetime1#,'%Y-%m-%d %H:%i:%s')
				
 				]]>
				
			</isNotEmpty>
			
			<isNotEmpty prepend="and" property="datetime2">
			<![CDATA[
 				 
				  a.StartTime< STR_TO_DATE(#datetime2#,'%Y-%m-%d %H:%i:%s')
 				]]>
				
			</isNotEmpty>
		 </dynamic>

	)e 
	group by e.route
	</select>
	
	
	<select id="querybusUserecord" parameterClass="map" resultClass="dto">
	SELECT distinct(t.PRODUCTID),t.route FROM bus.meta_site_route t 
<dynamic prepend="where">
			<isNotEmpty prepend="and" property="route">
				 t.Route= #route#
			</isNotEmpty>
			
			
		 </dynamic>
 <isNotEmpty prepend="and" property="datetime1">
			<![CDATA[
 				 t.StartTime> STR_TO_DATE(#datetime1#,'%Y-%m-%d %H:%i:%s')
				
 				]]>
				
			</isNotEmpty>
			
			<isNotEmpty prepend="and" property="datetime2">
			<![CDATA[
 				 
				  t.StartTime< STR_TO_DATE(#datetime2#,'%Y-%m-%d %H:%i:%s')
 				]]>
				
			</isNotEmpty>


	</select>
</sqlMap>