<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Bus">
	<typeAlias alias="dto" type="org.g4studio.core.metatype.impl.BaseDto" />
	<typeAlias alias="catalogVO" type="org.g4studio.demo.dao.vo.CatalogVO" />
	<typeAlias alias="userVo" type="org.g4studio.system.admin.web.tag.vo.UserVo"/>

	
	<!-- 定义出入参对象映射:测试游标 -->
	<parameterMap id="prcdto_cur" class="map">
		<parameter property="prm_Xm" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN" /> <!-- 入参 -->
		<parameter property="cur_list"  jdbcType="ORACLECURSOR" javaType="java.sql.ResultSet"  mode="OUT" resultMap="cur_dto"/>
		<parameter property="appCode" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT" /> <!-- 执行代码 -->
		<parameter property="errMsg" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT" /> <!-- 出错信息 -->
	</parameterMap>
	<resultMap id="cur_dto" class="dto">
		<result column="xm" property="xm" jdbcType="VARCHAR"/>
		<result column="fyze" property="fyze" jdbcType="DECIMAL"/>
	</resultMap>
	<procedure id="g4_prc_cursor_demo" parameterMap="prcdto_cur">{call g4_prc_cursor_demo(?,?,?,?)}</procedure>
	
	
	<select id="countStddev" parameterClass="map" resultClass="dto">
		SELECT 
		
		time_format(SEC_TO_TIME(stddev(TIME_TO_SEC(t.StartToMiddle))),'%H.%i.%s') as downpuls,
		time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.StartToMiddle))),'%H.%i.%s')
		 as downav  ,


		time_format(SEC_TO_TIME(stddev(TIME_TO_SEC(t.MiddleToEnd))),'%H.%i.%s') as uppuls,
			time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.MiddleToEnd))),'%H.%i.%s') as upav,
			
			t.ROUTEID as routeName FROM bus.tb_triptime t where 1=1   
			<dynamic>
			<isNotEmpty prepend="AND" property="selectroute">
				t.ROUTEID = #selectroute#
			</isNotEmpty>
			
			 group by t.ROUTEID
		</dynamic>
		
		
		
		
	</select>
	
	<select id="compareBustime" parameterClass="map" resultClass="dto">
	
	select a.ROUTEID as routename , a.rundate  ,a.StartTime,as_triptime as triptime ,b.downav as pretime,
		b.downpuls as plustime 
  	 from  (SELECT time_format(n.TripTime ,'%H.%i.%s') as as_triptime ,time_format(n.Startdate,'%H.%i.%s') as rundate,time_format(n.StartTime,'%H.%i.%s') as StartTime,n.ROUTEID as ROUTEID

 FROM tb_triptime n where n.PRODUCTID =#selectproductid# ) a 
left join (SELECT 
 
time_format(SEC_TO_TIME(stddev(TIME_TO_SEC(t.StartToMiddle))),'%H.%i.%s') as downpuls,
		time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.StartToMiddle))),'%H.%i.%s')
		 as downav  ,


		time_format(SEC_TO_TIME(stddev(TIME_TO_SEC(t.MiddleToEnd))),'%H.%i.%s') as uppuls,
			time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.MiddleToEnd))),'%H.%i.%s') as upav,

t.ROUTEID  FROM tb_triptime t where 1=1 group by t.ROUTEID  ) b on a.ROUTEID = b.ROUTEID
	</select>
	
	<select id="countcompareBustime" parameterClass="map" resultClass="java.lang.Integer">
	
	select count(*)
  	 from  (SELECT * 

 FROM tb_triptime n where n.PRODUCTID =#selectproductid# ) a 
left join (SELECT 
 
time_format(SEC_TO_TIME(stddev(TIME_TO_SEC(t.StartToMiddle))),'%H.%i.%s') as downpuls,
		time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.StartToMiddle))),'%H.%i.%s')
		 as downav  ,


		time_format(SEC_TO_TIME(stddev(TIME_TO_SEC(t.MiddleToEnd))),'%H.%i.%s') as uppuls,
			time_format(SEC_TO_TIME(avg(TIME_TO_SEC(t.MiddleToEnd))),'%H.%i.%s') as upav,

t.ROUTEID  FROM tb_triptime t where 1=1 group by t.ROUTEID  ) b on a.ROUTEID = b.ROUTEID
	</select>
	
	<select id="queryCompanyDatas" parameterClass="map" resultClass="dto">
		SELECT DEPTID as value, DEPTNAME as text
		FROM eadept
		<dynamic prepend="where">
			
			<isNotEmpty prepend="and" property="deptlength">
				length(DEPTID) = $deptlength$
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="queryrouteDatas" parameterClass="map" resultClass="dto">
		SELECT id as value, routename as text
		FROM meta_dept_route
		<dynamic prepend="where">
			
			<isNotEmpty prepend="and" property="deptid">
				DEPTID = #routename#
			</isNotEmpty>
		</dynamic>
	</select>
	
</sqlMap>